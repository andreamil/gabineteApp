<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Olá Mundo!</title>

    <link rel="stylesheet" href="./photon-0.1.2-dist/css/photon.min.css">    
    <script>
      const {ipcRenderer,shell , dialog} = require('electron');
      window.$ = require('jquery');
      </script>
    <link href="fancygrid/fancy.min.css" rel="stylesheet">
    <script src="fancygrid/fancy.full.formated.min.js"></script>         
    <script>
      Fancy.MODULESDIR = 'fancygrid/modules/';
    </script>
  </head>
  <body>
    <div class="window">
        <header class="toolbar toolbar-header" style="-webkit-app-region: drag;">
          
          <div class="toolbar-actions" >
  
            <div class="btn-group" id="groupHome">
              <button class="btn btn-large btn-default active" id="btn-clearfilter">
                <span class="icon icon-home" style="width: auto;height: auto;font-size: 16px;"></span>
              </button>
              <button class="btn btn-large btn-default" id="btn-geraretiqueta" style="display: none;">
                <span class="icon icon-print"style="width: auto;height: auto;font-size: 16px;"></span>
              </button>
              <button class="btn btn-large btn-default" id="btn-salvar" style="display: none;">
                <span class="icon icon-floppy"style="width: auto;height: auto;font-size: 16px;"></span>
              </button>
            </div>
  
            <button class="btn btn-large btn-default pull-right" id="btn-atualizar">
              <span class="icon icon-megaphone"></span>
            </button>
          </div>
        </header>
  
        <div class="window-content">
          <div class="pane-group">
            <div class="pane pane-sm sidebar">
                <nav class="nav-group" id="nav-cidades">
                  <h5 class="nav-group-title">Cidades</h5>
                  
                </nav>
                <nav class="nav-group" id="nav-cidades">
                  <h5 class="nav-group-title">Aniversariantes</h5>
                  <span class="nav-group-item">
                    <span class="icon icon-calendar"></span>
                    do Dia
                  </span>
                  <span class="nav-group-item">
                    <span class="icon icon-calendar"></span>
                    da Semana
                  </span>
                  <span class="nav-group-item">
                    <span class="icon icon-calendar"></span>
                    do Mes
                  </span>
                </nav>
            </div>
            <div class="pane">
                <div class="btn-group" style="position: fixed;top: 0;z-index: 99;margin-top: 4px;margin-bottom: 3px;padding-right: 3px;padding-left: 3px;padding-bottom: 3px;" id="groupTbar">
                    <button class="btn btn-large btn-default" id="btn-cadastro">
                      <span class="icon icon-user-add" style="width: auto;height: auto;font-size: 16px;"></span>
                    </button>
                    <button class="btn btn-large btn-default" id="btn-remover" style="display: none;">
                      <span class="icon icon-minus-circled" style="width: auto;height: auto;font-size: 16px;"></span>
                    </button>
                    <button class="btn btn-large btn-default" id="btn-editar" style="display: none;">
                      <span class="icon icon-doc-text" style="width: auto;height: auto;font-size: 16px;"></span>
                    </button>
                  </div>
                <div id="staff"></div>
            </div>
          </div>
        </div>
      </div>
      <script>
        var sqlite3 = require('sqlite3').verbose();
        const IMask = require('imask');
        var db = new sqlite3.Database(__dirname+'/individuos.db', (err) => {
          if (err) {
            console.error(err.message);
          }
          console.log('Connected to the chinook database.');
        });

        var dataMask,celularMask,staffEditForm;
        var saveButton = document.getElementById('btn-salvar'),
              editButton = document.getElementById('btn-editar'),
              gerarEtiquetaButton = document.getElementById('btn-geraretiqueta'),
                removeButton = document.getElementById('btn-remover');
        
              Fancy.defineController('staffGridControl', {
      onSelect: function(grid) {
        var selection = grid.getSelection();
        if (selection.length) {
          gerarEtiquetaButton.style.display = "";

          if (selection.length === 1) {
            editButton.style.display = "";
            removeButton.style.display = "";
          } else {
            editButton.style.display = "none";
            removeButton.style.display = "none";
          }
        }else{
          gerarEtiquetaButton.style.display = "none";        
        }
      },
      onClearSelect: function(grid) {
        editButton.style.display = "none";
        removeButton.style.display = "none";
      },
      onRowDBLClick: function(grid, o) {
        grid.editUser(o.data);
      },
      editUser: function(item) {
        var me = this;
          staffEditForm = me.staffEditForm;
        
        let idSelected=Object.keys(grid.selection.memory.selected)[0]
      if (staffEditForm) {
        console.log(idSelected)
        staffEditForm.clear();
        staffEditForm.set(grid.store.map[idSelected].data);
        item.dataDeNascimento==''||item.dataDeNascimento==undefined||item.dataDeNascimento==null
          ?staffEditForm.set('dataDeNascimento','01/01/1980')
          :{}
        staffEditForm.setTitle('Dados da pessoa (id=' + idSelected+')');

        staffEditForm.show();
      } else {
        staffEditForm = new FancyForm({
            theme: 'bootstrap',
            title: {
            text: 'Dados da pessoa (id=' +idSelected+')',
            tools: [{
              text: 'Fechar',
              handler: function() {
                this.hide();
              }
            }]
          },
          window: true,
          draggable: true,
          width: 500,
          height: 570,
            i18n: 'pt-BR',
            defaults: {
              type: 'string',
            },
            items: [{
              name: 'id',
              type: 'hidden',
              value: idSelected
            }, {
              type: 'line',
              defaults: {
              labelAlign: 'top',},
              items: [{
                label: 'Nome Completo',
                name: 'nomeCompleto',
              value: item.nomeCompleto
              },{
                label: 'Apelido',
                emptyText: 'Apelido',
                name: 'apelido',
              value: item.apelido
              },]
            }, {
                type: 'line',
                defaults: {
                labelAlign: 'top',},
                items: [{
                label: 'E-mail',
                emptyText: 'E-mail',
                name: 'email',
                valid: {
                  type: 'email',
                  blank: false,
                  blankText: 'Required',
                  text: 'Incorect email'
                },
              value: item.email
              },{
                type: 'date',
                label: 'Data de Nascimento',
                name: 'dataDeNascimento', 
                id: 'inputData',
                value: item.dataDeNascimento==''||item.dataDeNascimento==undefined||item.dataDeNascimento==null
                        ?'01/01/1980'
                        :item.dataDeNascimento,
                format: {
                  read: 'd/m/Y',
                  write: 'd/m/Y',
                  edit: 'd/m/Y'              
                },     
              events: [{
                change: (v) =>{if(dataMask!=undefined||dataMask!=null){dataMask.masked.value = dataMask.el.value;
                                                                      dataMask._value = dataMask.masked.value;} return v;}
              },{
                input: (v) =>{if(dataMask!=undefined||dataMask!=null){dataMask.masked.value = dataMask.el.value;
                                                                      dataMask._value = dataMask.masked.value;} return v;}
              }]
              },]
            }, {
                type: 'line',
                defaults: {
                labelAlign: 'top',},
                items: [{
                type: 'combo',
                label: 'Cidade',
                name: 'cidade',
                value: item.cidade,
                data: {
                  proxy: {

                    url: __dirname+'/cidadesSc.json'
                  }
                },
                displayKey: 'text',
                valueKey: 'text'
                },{
                type: 'combo',
                label: 'Estado',
                name: 'estado',
                value: item.estado,
                data: ["AC", "AL", "AM", "AP", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RO", "RS", "RR", "SC", "SE", "SP", "TO"],
                displayKey: 'text',
                valueKey: 'text'
                },{
                  type: 'string',
                  label: 'Cep',
                  name: 'cep',
                value: item.cep,
                }]
              },
              {
                type: 'line',
                defaults: {
                labelAlign: 'top',},
                items: [{
                type: 'string',
                label: 'Rua',
                name: 'rua',
                value: item.rua,
              },{
                type: 'string',
                label: 'Bairro',
                name: 'bairro',
                value: item.bairro,
              },{
                type: 'string',
                label: 'Número',
                name: 'numero',
                value: item.numero,
              }]
            },{
                type: 'line',
                defaults: {
                labelAlign: 'top',},
                items: [{
                type: 'string',
                label: 'Função',
                name: 'funcao',
                value: item.funcao?item.funcao:'',
              },{
                type: 'string',
                label: 'Telefone',
                name: 'telefone',
                value: item.telefone?item.telefone:'',
              },{
                type: 'string',
                label: 'Celular',
                name: 'celular',
                id: 'inputCelular',
                value: item.celular,
                emptyText: '(xx) xxxxx-xxxx',
                format: {
                  inputFn: (v) =>v.toString().replace(/\D/g,"").replace(/^(\d{2})(\d)/g,'($1) $2').replace(/(\d)(\d{4})$/,'$1-$2')
                }
              },]
            },{
                type: 'line',
                defaults: {
                  labelAlign: 'top'
                },
                items: [{
                  type: 'textarea',
                  label: 'Observações',
                  name: 'observacoes',
                  value: item.observacoes,
                }]
            },],
            events: [{
              init: function() {
                //item.$selected= true;
                this.show();       
              }
            }],
            buttons: [{
              text: 'Imprimir etiqueta',
              handler: gerarEtiqueta
            },'side', {
              text: 'Fechar',
              handler: function(){
                this.hide();
              }
            },{
              text: 'Salvar',
              handler: function(){
                me.getById(this.get('id')).set(this.get());
                saveButton.style.display='';
                me.update();
                this.hide();
              }
            }],

          });

        me.staffEditForm = staffEditForm;        

      }
      dataMask= new IMask(Fancy.getWidget('inputData').input.dom, {
                        mask: Date,  // enable date mask

                          // other options are optional
                          pattern: 'd/`m/`Y',  // Pattern mask with defined blocks, default is 'd{.}`m{.}`Y'
                          // you can provide your own blocks definitions, default blocks for date mask are:
                          blocks: {
                            d: {
                              mask: IMask.MaskedRange,
                              from: 1,
                              to: 31,
                              maxLength: 2,
                            },
                            m: {
                              mask: IMask.MaskedRange,
                              from: 1,
                              to: 12,
                              maxLength: 2,
                            },
                            Y: {
                              mask: IMask.MaskedRange,
                              from: 1900,
                              to: 2019,
                            }
                          },
                          // define date -> str convertion
                          format: function (date) {
                            var day = date.getDate();
                            var month = date.getMonth() + 1;
                            var year = date.getFullYear();

                            if (day < 10) day = "0" + day;
                            if (month < 10) month = "0" + month;

                            return [day, month, year].join('/');
                          },
                          // define str -> date convertion
                          parse: function (str) {
                            var yearMonthDay = str.split('/');
                            return new Date(yearMonthDay[2], yearMonthDay[1] - 1, yearMonthDay[0]);
                          },

                          // optional interval options
                          min: new Date(1900, 0, 1),  // defaults to 1900-01-01
                          max: new Date(2020, 0, 1),  // defaults to 9999-01-01

                          // also Pattern options can be set
                          lazy: false
                      })
    }
  });
        let selectedId,ultimoId;
        var cidades=[], grid;

        document.addEventListener("DOMContentLoaded", function() {
        db.all("SELECT * FROM individuos", [], (err, rows) => {
              if (err) {
                throw err;
              }
              ultimoId = rows[rows.length-1].id;
              
              rows.forEach(function(item) {
                var index = cidades.findIndex(x => x.nome==item.cidade);
                index!=-1?cidades[index].count++  
                         :cidades.push({nome: item.cidade,count: 1});
              });
              cidades.sort((a,b) => (a.count > b.count) ? -1 : ((b.count > a.count) ? 1 : 0)); 
          
              grid = new FancyGrid({
                theme: 'bootstrap',
                renderTo: 'staff',  
                data: rows,
                i18n: 'pt-BR',
                gridBorders: [0,0,0,0],
                gridWithoutPanelBorders: [0,0,0,0],
                filter: true,
                searching: true,
                /*tbar: [{
                text: 'Adicionar',
                handler: function(){
                  var b=this;
                  ultimoId++;
                  b.add({id: ultimoId});
                  b.scroll();
                }
              }, {
                text: 'Remover',
                action: 'remove',
                tip: 'Selecione para remover',
              }, {
                text: 'Editar',
                disabled: true,
                tip: 'Selecione para editar <br> Ou duplo clique na linha',
                handler: function() {
                  var me = this,
                    selection = me.getSelection(),
                    item = selection[0];

                  this.editUser(item);
                }
              }],*/
              selModel: {
                type: 'rows',
                memory: true
              },
              trackOver: true,  
              exporter: true,
              controllers: ['staffGridControl'],
              defaults: {
                type: 'string',
                sortable: true,
                resizable: true,    
                flex: 1,
                draggable: true,
                vtype: 'notempty',
                menu: true,
                filter: {
                  header: true
                }
              },
              clicksToEdit: 1,
              columnLines: false,
              columnClickData: true,
              contextmenu: [
                  'copy',
                  'copy+',
                  '-',
                  'duplicate',
                  '-',
                  'delete',
                  '-',
                  'export',
                  {
                    text: 'Custom',
                    imageCls: 'custom-menu-item-cls',
                    sideText: 'CUSTOM',
                    handler: function() {
                      alert('Click on custom item');
                    }
                  }
              ],
            events: [{
                select: 'onSelect'
              }, {
                clearselect: 'onClearSelect'
              }, {
                rowdblclick: 'onRowDBLClick'
              }, {
                filter: function() {
                  setActive(Object.keys(this.filter.filters).length?null:'btn-clearfilter');
                  }
              }, {
                init: function() {
                  //setActive(Object.keys(this.filter.filters).length?null:'btn-clearfilter');
                  //this.fitHeight()
                  }
              }],
            columns: [{
              index: 'id',
              title: 'Id',
              editable: false,
              select: true,
              type: 'number',
              flex: 0,
              width: 60,
              filter: {
                header: true,
                tip: [
                  'Contêm: 30<br>',
                  'Menor que: <30<br>',
                  'Maior que: >30<br>',
                  'Igual a: 30<br>',
                  'Diferente de: !=30<br>',
                  'Composição: <30,>5'
                ].join("")
              }
            },{
              index: 'nomeCompleto',
              title: 'Nome Completo',
              ellipsis: true,
              filter: {
                header: true,
                tip: [
                  'Contêm: Ted<br>',
                  'Igual a: =Ted Smith<br>',
                  'Diferente de: !=Ted Smith<br>'
                ].join("")
              }
              },{
              index: 'dataDeNascimento',
              title: 'Aniversário',
              type: 'date',
              flex: 0,
              width: 100,  
              format: {
                read: 'd/m',
                write: 'd-F',
                edit: 'd/m'
              },
            },{
              index: 'email',
              title: 'Email',
              ellipsis: true,
              filter: {
                header: true,
                tip: [
                  'Contêm: Java<br>',
                  'Igual a: =Project Manager<br>',
                ].join("")
              },
            },{
              index: 'cidade',
              title: 'Cidade',
              type: 'combo',
              id: 'comboCidade',
            multiSelect: true,
            itemCheckBox: true,
              data: cidades.map(a => a.nome)
            },{
              title: 'Celular',
              name: 'celular',
              index: 'celular',
              type: 'string',
              format: {
                inputFn: (v) =>v.toString().replace(/\D/g,"").replace(/^(\d{2})(\d)/g,'($1) $2').replace(/(\d)(\d{4})$/,'$1-$2')
              }
            }]
          });
          console.log(grid)
          cidades.map(a => a.nome).forEach(function(item){
                var navCidadeGroupItem = document.createElement('span');
                navCidadeGroupItem.classList.add('nav-group-item');
                navCidadeGroupItem.innerHTML = "<span class='icon icon-network'></span>"+item;

                document.getElementById('nav-cidades').appendChild(navCidadeGroupItem).addEventListener('click',function(){
                   grid.columns[4].filterField.set(item);
                   grid.columns[4].filterField.selectItem(grid.columns[4].filterField.data.findIndex(x => x.text==item));
                   grid.columns[4].filterField.updateInput();
                });

              })
         
        });
          
        });
          </script>
      <script>
        function gerarEtiqueta(){
          
let request = require('request');
let fs = require('fs');
const { shell , dialog} = require('electron');
          console.log(grid.selection.memory.selectedLength);
          for (let pagina = 0; pagina < Math.ceil(grid.selection.memory.selectedLength/14); pagina++) {
            
            let params = {}
            params['opcao']='etiqueta';
            params['to']='14';
            params['tamanhoFonte']='P';
            for (let i = 0; i < 14; i++) {
                let data = Object.keys(grid.selection.memory.selected)[i+(14*pagina)] ? grid.getById(Object.keys(grid.selection.memory.selected)[i+(14*pagina)]).data: {};
                let k=i+1;
                params['tipo_'+(k)]='des';
                params['complemento_'+k]='';
                params['tratamento_'+k]='';
                params['tipo_Cep_'+k]='';
                params['cep_'+k]=data.cep?data.cep:'';
                params['nome_'+k]=data.nomeCompleto?data.nomeCompleto:'';
                params['empresa_'+k]=data.empresa?data.empresa:'';
                params['endereco_'+k]=data.rua?data.rua:'';
                params['numero_'+k]=data.numero?data.numero:'';
                params['cidade_'+k]=data.cidade?data.cidade:'';
                params['uf_'+k]=data.estado?data.estado:'';
                params['selUf_'+k]=params['uf_'+k]
                params['telefone_'+k]=data.celular?data.celular:'';
                console.log(params['telefone_'+k],data.telefone,data.celular)
                params['complemento_'+k]=data.observacoes?data.observacoes:'';
                params['bairro_'+k]=data.bairro?data.bairro:'';
            }

            params = Object.keys(params).map(k => encodeURIComponent(k) + '=' + escape(params[k])).join('&');
            console.log(params);
            //ipcRenderer.send('gerarEtiquetas',params);
            request({
              encoding: null,
              url: 'http://www2.correios.com.br/enderecador/cartas/act/gerarEtiqueta.cfm',
              method: 'POST',
              body: params,
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded' },
              followRedirect : false,
                
                //simple: false
            },(err, httpResponse, body) => {
              if (err) {
                return console.error('erro postEtiqueta:', err);
              }
              fs.writeFile(__dirname+'/temp'+pagina+'.pdf', body, function(err) {
                if(err) {
                    return console.log(err);
                }
                shell.openItem(__dirname+'/temp'+pagina+'.pdf');
              });
            });
          }
         
          /*
              var printer = require('printer'),
              var util = require('util');
              //console.log("installed printers:\n"+util.inspect(printer.getPrinters(), {colors:true, depth:10}));
            //    printer.printDirect({data:a,
            //    printer: 'Microsoft Print to PDF',
            //    success:function(jobID){
            //      console.log("sent to printer with ID: "+jobID);
            //    },
            //    error:function(err){
            //      console.log(err);
            //    }
            //  });
            */
        }      
        function setActive(id){
          var c = document.getElementById("groupHome").children;
          c[0].classList.remove("active");
          c[1].classList.remove("active");
          if(id!=null&&id!=''&&id!=undefined)document.getElementById(id).classList.add("active");
        }
        document.getElementById('btn-clearfilter').addEventListener('click', function(event) {  
          setActive('btn-clearfilter');
          //console.log(grid.filter.filters);
          if(Object.keys(grid.filter.filters).length){grid.clearFilter();grid.columns[0].filterField.set("");};
        }); 
        document.getElementById('btn-geraretiqueta').addEventListener('click', function(event) {  
          gerarEtiqueta();
        });
        document.getElementById('btn-salvar').addEventListener('click', function(event) {  
          db.serialize(()=>{
            db.run("CREATE TABLE IF NOT EXISTS individuos ( `nomeCompleto` TEXT, `apelido` TEXT, `dataDeNascimento` TEXT, `email` TEXT, `cidade` TEXT, `cep` INTEGER, `rua` TEXT, `bairro` TEXT, `numero` TEXT, `observacoes` TEXT, `telefone` TEXT, `celular` TEXT, `funcao` INTEGER, `id` INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE )");
            grid.getData().forEach((p,i)=>{
              let fields= Object.keys(grid.getData()[i]),
              values= Object.values(grid.getData()[i]);
              if(grid.getData()[i]["$selected"] === true||grid.getData()[i]["$selected"] === false){
                values.splice(15,1);
                fields.splice(15,1);
              }
              values=values.map(v=>`'${v}'`).join(',');
              db.run("INSERT OR REPLACE INTO individuos ("+fields+") VALUES ("+values+");");
            });
            
          })
        saveButton.style.display='none';
        });
        document.getElementById('btn-cadastro').addEventListener('click', function(event) {  
                  ultimoId++;
                  grid.add({id: ultimoId});
                  //console.log(grid.scroller.getScrollHeight());
                  grid.selectById(ultimoId);
                  grid.scrollToRow(ultimoId);
                  //staffEditForm.clear();
                  //staffEditForm.set(grid.store.map[ultimoId].data)
                  grid.editUser(ultimoId);
                  //grid.scroll(grid.scroller.getScrollHeight());
                  grid.scroller.update();
                  saveButton.style.display='';
        });       
            
        document.getElementById('btn-remover').addEventListener('click', function(event) { 
          const options = {
            type: 'question',
            buttons: ['Cancelar', 'Sim'],
            defaultId: 0,
            title: 'Remover',
            message: 'Remover',
            detail: 'Remover dados da pessoa?\n'+grid.getSelection(),
          };

          dialog.showMessageBox(null, options, (response) => {
            
            if(response==1){
              if(grid.getSelection()){
              //Fancy.each(grid.getSelection(), function(a) {
                db.delete("individuos","id=?",grid.getSelection()[0].id)
                ?grid.remove(a)
                :alert("erro ao remover")
              //});
              grid.selection.clearSelection();
            }
            }
          }); 
          
        });    
        document.getElementById('btn-editar').addEventListener('click', function(event) {  
              selection = grid.getSelection(),
              item = selection[0];
          if(grid.getSelection())grid.editUser(item);
        });   

      </script>
  </body>
</html>